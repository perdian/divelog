<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout/default :: html(_, _, ~{::main})">
  <body>
    <main>

      <div class="ui header">
        <i class="home icon"></i>
        <div class="content" th:text="#{overview}"></div>
      </div>
      <div class="ui divider"></div>

      <div class="ui stackable grid">
        <div class="row">
          <div class="four wide column">
            <h3 th:text="#{dive_totals}">Dive totals</h3>
            <table class="ui very basic compact table">
              <tbody>
                <tr>
                  <td th:text="#{total_number_of_dives}">Total number of dives</td>
                  <td class="right aligned" th:text="${overview.totalDives}">42</td>
                </tr>
                <tr>
                  <td th:text="#{aggregated_underwater_time}">Aggregated underwater time</td>
                  <td class="right aligned">
                    <span th:text="${#divelog.formatNumber(overview.aggregatedTotalTimeMinutes / 60d, '#,##0.#')}">Time</span>
                    <span th:text="#{unit.h}" />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="four wide column">
            <h3 th:text="#{dives_by_location_type}">Dives by location type</h3>
            <table th:replace="overview/fragments/aggregation-tables :: aggregation-items(${overview.aggregatedLocationTypes}, 'PlaceType')"></table>
          </div>
          <div class="four wide column">
            <h3 th:text="#{dives_by_water_type}">Dives by water type</h3>
            <table th:replace="overview/fragments/aggregation-tables :: aggregation-items(${overview.aggregatedWaterTypes}, 'WaterType')"></table>
          </div>
          <div class="four wide column">
            <h3 th:text="#{dives_by_suit_type}">Dives by suit type</h3>
            <table th:replace="overview/fragments/aggregation-tables :: aggregation-items(${overview.aggregatedSuitTypes}, 'SuitType')"></table>
          </div>
        </div>
      </div>

      <div class="ui fluid card">
        <div id="globalMap" class="image" style="width: 100%; height: 500px" th:data-endpoint="@{/api/locations/overview}">
        </div>
      </div>
      <script type="text/javascript">

          let globalMap = createMap($("#globalMap").get(0))
          globalMap.setView(new ol.View({
              center: ol.proj.fromLonLat([0, 25]),
              zoom: 1.85
          }));

          function globalMapAddLocationsForType(locations, style) {
              var locationsSource = new ol.source.Vector();
              for (var i=0; i < locations.length; i++) {

                  var location = locations[i];
                  var locationFeature = new ol.Feature({
                      geometry: new ol.geom.Point(ol.proj.transform([location.coordinates.longitude, location.coordinates.latitude], 'EPSG:4326', 'EPSG:3857')),
                  });

                  locationFeature.setStyle(style);
                  locationsSource.addFeature(locationFeature);

              }
              globalMap.addLayer(new ol.layer.Vector({ source: locationsSource }));
          }

          function globalMapAddLocations(data) {

              globalMapAddLocationsForType(data.locations, new ol.style.Style({
                  image: new ol.style.Circle({
                      radius: 2,
                      fill: new ol.style.Fill({
                          color: 'rgba(10,10,10,0.5)'
                      }),
                      stroke: new ol.style.Stroke({
                          color: 'rgba(10,10,10,0.8)',
                          width: 3
                      })
                  })
              }));

              globalMapAddLocationsForType(data.spots, new ol.style.Style({
                  image: new ol.style.Circle({
                      radius: 2,
                      fill: new ol.style.Fill({
                          color: 'rgba(100,10,50,0.5)'
                      }),
                      stroke: new ol.style.Stroke({
                          color: 'rgba(100,10,50,0.8)',
                          width: 3
                      })
                  })
              }));

              globalMap.render();
          }

          $.ajax({
              url: $("#globalMap").attr("data-endpoint"),
              success: globalMapAddLocations
          });

      </script>

    </main>
  </body>
</html>
