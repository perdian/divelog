<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout/default :: html(_, _, ~{::main})" th:with="a='b'">
  <body>
    <main class="ui container">

      <h2 class="ui header">
        <i class="plus icon"></i>
        <div class="content">
          Add dive
          <div class="sub header">Add information about new dive</div>
        </div>
      </h2>

      <script type="text/javascript">

          function renderMap(target, longitude, latitude) {

              let mapLayer = new ol.layer.Tile({
                  source: new ol.source.OSM()
              })

              let locationFeature = new ol.Feature({
                  geometry: new ol.geom.Point(ol.proj.transform([longitude, latitude], 'EPSG:4326', 'EPSG:3857'))
              });
              let locationSource = new ol.source.Vector();
              locationSource.addFeature(locationFeature);
              let locationLayer = new ol.layer.Vector({ source: locationSource })

              var map = new ol.Map({
                  target: target,
                  projection: "EPSG:3857",
                  layers: [mapLayer, locationLayer],
                  view: new ol.View({
                    center: ol.proj.fromLonLat([longitude, latitude]),
                    zoom: 11
                  }),
                  controls: [
                    new ol.control.Zoom()
                  ]
              });
              map.render();

          }

      </script>


      <form class="ui form" th:action="@{/dives/add}" th:object="${dive}" method="post">

        <div class="ui horizontal divider">General information</div>

        <div class="fields">
          <div class="one wide field">
            <label>No</label>
            <input type="number" th:field="*{number}" readonly />
          </div>
          <div class="three wide field">
            <label>Date</label>
            <input type="date" th:field="*{start.dateIso}" />
          </div>
          <div class="twelve wide field">
            XX
          </div>
        </div>

        <div class="ui horizontal divider">Location</div>

        <div class="fields">
          <div class="six wide field">
            <label>Location</label>
            <div class="ui action input">
            <input th:field="*{start.location.name}" th:data-searchEndpoint="@{/api/places/search}" />
              <button type="button" id="startLocationSearch" class="ui button">Search</button>
            </div>
          </div>
          <script type="text/javascript">
              $("#startLocationSearch").click(function() {
                  let locationValue = $("input[name='start.location.name']").val().trim();
                  if (locationValue.length > 0) {
                    searchLocation(locationValue, {
                        nameField: $("input[name='start.location.name']"),
                        latitudeField: $("input[name='start.location.latitude']"),
                        longitudeField: $("input[name='start.location.longitude']"),
                        timezoneIdField: $("input[name='start.location.timezoneId']"),
                    })
                  }
              });
          </script>

          <div class="four wide field">
            <label>Timezone</label>
            <input th:field="*{start.location.timezoneId}" />
          </div>
          <div class="three wide field">
            <label>Latitude</label>
            <input th:field="*{start.location.latitude}" />
          </div>
          <div class="three wide field">
            <label>Longitude</label>
            <input th:field="*{start.location.longitude}" />
          </div>
        </div>

        <div class="ui horizontal divider">Spot</div>

        <div class="ui horizontal divider">Actions</div>

        <button type="submit" class="ui primary button">
          <i class="save icon"></i>
          Save
        </button>

      </form>

      <div id="searchLocationForm" class="ui modal">
      </div>

      <script type="text/javascript">
        function searchLocation(locationValue, targetFields) {
            searchLocationPrepare(locationValue);
            $("#searchLocationForm").modal("show");
            searchLocationExecute(locationValue, targetFields);
        }

        function searchLocationPrepare(locationValue) {
            $("#searchLocationForm").empty();
            $("#searchLocationForm").append(
                $("<i class='close icon'></i>"),
                $("<div class='ui icon header'></div>").append(
                    $("<i class='compass icon'></i>"),
                    $("<span id='searchLocationTitle'>Searching for location '" + locationValue + "'</span>")
                ),
                $("<div id='searchLocationBody' class='ui segment'></div>").append(
                    $("<div class='ui active inverted dimmer'></div>").append(
                        $("<div class='ui text loader'>Loading</div>")
                    ),
                    $("<p>&nbsp;</p>"),
                    $("<p>&nbsp;</p>"),
                    $("<p>&nbsp;</p>")
                )
            );
        }

        function searchLocationExecute(locationValue, targetFields) {
            $.ajax({
                url: $("input[name='start.location.name']").attr("data-searchEndpoint") + "?q=" + encodeURIComponent(locationValue),
                success: function(data) { searchLocationShowResults(data, locationValue, targetFields); },
                error: function(xhr, textStatus, thrownError) { searchLocationShowError(thrownError, locationValue); }
            });
        }

        function searchLocationShowResults(result, locationValue, targetFields) {
            $("#searchLocationTitle").text("Search results for location: '" + locationValue + "'");
            $("#searchLocationBody").empty();
            if (result.items.length < 1) {
                $("#searchLocationBody").append(
                    $("<div class='ui warning message'></div>").append(
                        $("<div class='header'></div>").text("No results"),
                        $("<p></p>").text("The search didn't return any results")
                    )
                );
            } else {
                let mapRenderActions = [];
                let parentElement = $("<div class='ui divided items'></div>");
                for (let itemIndex = 0; itemIndex < result.items.length; itemIndex++) {
                    let item = result.items[itemIndex];
                    let mapElement = document.createElement("div");
                    mapRenderActions.push(function() { renderMap(mapElement, item.longitude, item.latitude) })
                    parentElement.append(
                        $("<div class='item'></div>").append(
                            $(mapElement).attr("class", "ui tiny image").attr("style", "width: 200px !important; height: 150px !important; border: 1px solid black;"),
                            $("<div class='middle aligned content'></div>").append(
                                $("<a class='header'></a>").text(item.name).click(function() { searchLocationSelect(item, targetFields); }),
                                $("<div class='meta'></div>").text(item.description),
                                $("<div class='description'></div>").append(
                                    $("<button class='ui right primary button'>Select</button>").click(function() { searchLocationSelect(item, targetFields); })
                                )
                            )
                        )
                    );
                }
                $("#searchLocationBody").append(parentElement);
                mapRenderActions.forEach(action => action());
            }
        }

        function searchLocationShowError(error, locationValue) {
            $("#searchLocationTitle").text("Search failed for location: '" + locationValue + "'");
            $("#searchLocationBody").empty();
            $("#searchLocationBody").append(
                $("<div class='ui negative message'></div>").append(
                    $("<div class='header'></div>").text("Search failed"),
                    $("<p></p>").text(error)
                )
            );
        }

        function searchLocationSelect(item, targetFields) {
            targetFields.latitudeField.val(item.latitude);
            targetFields.longitudeField.val(item.longitude);
            targetFields.timezoneIdField.val(item.timezoneId);
            $("#searchLocationForm").modal("hide");
        }

      </script>

    </main>
  </body>
</html>
